

```{r}
pacman::p_load(rmarkdown,ggplot2,lime,microbenchmark,rmdformats,
               sn,scatterplot3d,rhandsontable,ggraph,tidygraph,knitr,
               openxlsx,vroom,tidyverse,DT,rpart,rpart.plot,ggmap,
               flexdashboard,geojsonR,maptiles,mapsf,osrm,rgdal,sf,
               leaflet,readr)
```
```{r}
getwd()
```

# Comparateur CP

## nettoyage

```{r}
comp=read.csv2("../data/insee/base_cc_comparateur.csv",dec=".")%>%
  data.table()
```


```{r}
var_selec=c("P17_POP","P12_POP","SUPERF","NAIS1217","DECE1217","P17_MEN","NAISD19","DECESD19","P17_LOG",
            "P17_RP","P17_RSECOCC","P17_LOGVAC","P17_RP_PROP","NBMENFISC17","PIMP17","MED17","TP6017","P17_EMPLT",
            "P17_EMPLT_SAL","P12_EMPLT","P17_POP1564","P17_CHOM1564","P17_ACT1564","ETTOT15","ETAZ15","ETBE15","ETFZ15","ETGU15","ETGZ15","ETOQ15",
            "ETTEF115","ETTEFP1015")

for (n in var_selec){
  comp[[n]]=as.numeric(comp[[n]])
}
```


```{r}
comp$dpop17=comp$P17_POP/comp$SUPERF
comp$dpop12=comp$P12_POP/comp$SUPERF
comp$tnai17=comp$NAIS1217/comp$P17_POP
comp$dlog17=comp$P17_LOG/comp$SUPERF
comp$trp17=comp$P17_RP/comp$P17_LOG

comp$tchom=comp$P17_CHOM1564/comp$P17_ACT1564
```

```{r}
comp$etpsurf=comp$ETTOT15/comp$SUPERF
comp$etppop=comp$ETTOT15/comp$P17_POP

comp$tETAZ15=comp$ETAZ15/comp$ETTOT15
comp$tETBE15=comp$ETBE15/comp$ETTOT15
comp$tETFZ15=comp$ETFZ15/comp$ETTOT15
comp$tETGU15=comp$ETGU15/comp$ETTOT15
comp$tETGZ15=comp$ETGZ15/comp$ETTOT15
comp$tETOQ15=comp$ETOQ15/comp$ETTOT15
comp$tETTEF115=comp$ETTEF115/comp$ETTOT15
comp$tETTEFP1015=comp$ETTEFP1015/comp$ETTOT15

```


## Par code postal

si la jointure se fait par code postal, on peut faire une aggrégation par code postal.
Mais dans le fichier de sirene, on a le code insee


```{r}

cpinsee=read.csv2("../data/correspondance-code-insee-code-postal.csv")%>%data.table()

```

```{r}
comp=merge(comp,cpinsee,by.x="CODGEO",by.y="Code.INSEE")

comp[,.N,by=Code.Postal]

```

```{r}
comp[Code.Postal=="10200"]
```


```{r}
comp_cp=comp[,.(dpop17=mean(dpop17),
                dpop12=mean(dpop12),
                tnai17=mean(tnai17),
                dlog17=mean(dlog17),
                trp17=mean(trp17),
                tchom=mean(tchom),
                med=mean(MED17)),
             by=Code.Postal]
```


```{r}
names(comp_cp)
```


## jointure avec siret

on fait une jointure pour avoir des infos insee pour les établissements

```{r}

siret_comp=merge(siret,
          comp,
          by.x="codeCommuneEtablissement",
          by.y="Code.Postal",
          all.x=T)

```

```{r}
names(siret_comp)
```

## Aggrégation SIREN

Pour une entreprise, on fait une aggrégation

```{r}
siren_comp=siret_comp[,.(net=.N,
                         anc=mean(ancien,na.rm=T),
                         dpop17=mean(dpop17,na.rm=T),
                         dpop12=mean(dpop12,na.rm=T),
                         tnai17=mean(tnai17,na.rm=T),
                         dlog17=mean(dlog17,na.rm=T),
                         trp17=mean(trp17,na.rm=T),
                         tchom=mean(tchom,na.rm=T),
                         MED17=mean(MED17,na.rm=T),
                         TP6017=mean(TP6017,na.rm=T),
                         etpsurf=mean(etpsurf,na.rm=T),
                         etppop=mean(etppop,na.rm=T),
                         tETAZ15=mean(tETAZ15,na.rm=T),
                         tETBE15=mean(tETBE15,na.rm=T),
                         tETFZ15=mean(tETFZ15,na.rm=T),
                         tETGU15=mean(tETGU15,na.rm=T),
                         tETGZ15=mean(tETGZ15,na.rm=T),
                         tETOQ15=mean(tETOQ15,na.rm=T),
                         tETTEF115=mean(tETTEF115,na.rm=T),
                         tETTEFP1015=mean(tETTEFP1015,na.rm=T),
                         P17_POP=sum(P17_POP,na.rm=T),
                         SUPERF=sum(SUPERF,na.rm=T),
                         P12_POP=sum(P12_POP,na.rm = T),
                         NAIS1217=sum(NAIS1217,na.rm = T),
                         DECE1217=sum(DECE1217,na.rm = T),
                         P17_MEN=sum(P17_MEN,na.rm = T),
                         NAISD19=sum(NAISD19,na.rm=T),
                         DECESD19=sum(DECESD19,na.rm = T),
                         P17_LOG=sum(P17_LOG,na.rm=T),
                         P17_LOGVAC=sum(P17_LOGVAC,na.rm=T),
                         ETAZ15=sum(ETAZ15,na.rm=T),
                         ETBE15=sum(ETBE15,na.rm=T),
                         ETFZ15=sum(ETFZ15,na.rm=T),
                         ETGU15=sum(ETGU15,na.rm=T),
                         ETGZ15=sum(ETGZ15,na.rm=T),
                         ETOQ15=sum(ETOQ15,na.rm=T)),
                      by=siren]


```



# IRIS

## Iris

données venant d'apur (Paris)

```{r}
iris_data=iris_apur@data%>%data.table()
iris_data$C_IR=as.character(iris_data$C_IR)
```

```{r}

iris_data=iris_data%>%
  mutate(totalm2=M2_POP+M2_EMP-M2_IP,
         testp=totalm2/SHAPE_Area,
         pstat=M2_IP/SHAPE_Area,
         ppop=M2_POP/SHAPE_Area,
         pemp=M2_EMP/SHAPE_Area)

datatable(iris_data[substr(C_CAINSEE,1,2)=="75",
                    c("C_IR","L_IR","pstat","ppop","pemp")])

```

```{r}

sum(iris_data[substr(C_CAINSEE,1,2)=="75"]$SHAPE_Area)
sum(iris_data[substr(C_CAINSEE,1,2)=="75"]$totalm2)
sum(iris_data[substr(C_CAINSEE,1,2)=="75"]$M2_IP)

sum(iris_data[substr(C_CAINSEE,1,2)=="75"]$M2_POP)/sum(iris_data[substr(C_CAINSEE,1,2)=="75"]$SHAPE_Area)
sum(iris_data[substr(C_CAINSEE,1,2)=="75"]$M2_EMP)/sum(iris_data[substr(C_CAINSEE,1,2)=="75"]$SHAPE_Area)


iris_data[substr(C_CAINSEE,1,2)=="75",.(sum(SHAPE_Area)),
          by="C_CAINSEE"]

```


## Revenu

```{r}
fildisp_var=read.xlsx("../data/insee/BASE_TD_FILO_DISP_IRIS_2018.xlsx",
                  sheet="Variables",
                  startRow = 6,
                  colNames = TRUE,
                  skipEmptyCols = TRUE,
                  rows = NULL,
                  cols = NULL, check.names = FALSE,
                  namedRegion = NULL, 
                  na.strings = "NA", 
                  fillMergedCells = FALSE)%>%
  data.table()

```

```{r}
fildisp=read.xlsx("../data/insee/BASE_TD_FILO_DISP_IRIS_2018.xlsx",
                  startRow = 6,
                  colNames = TRUE,
                  skipEmptyCols = TRUE,
                  rows = NULL,
                  cols = NULL, check.names = FALSE,
                  namedRegion = NULL, 
                  na.strings = "NA", 
                  fillMergedCells = FALSE)%>%
  data.table()
```



```{r}
fildisp$DISP_D518=fildisp$DISP_MED18

fildisp_75=fildisp[substr(COM,1,2)=="75",]

fildisp_75_g=gather(fildisp[substr(COM,1,2)=="75",
                            c("IRIS","LIBIRIS","COM",paste0("DISP_D",1:9,"18"))],
                    "dispd","montant",-c("IRIS","LIBIRIS","COM"))%>%data.table()
```

déclaration et disponible

```{r}
fildec=read.xlsx("../data/insee/BASE_TD_FILO_DEC_IRIS_2018.xlsx",startRow = 6, colNames = TRUE,
                    skipEmptyCols = TRUE, rows = NULL, cols = NULL, check.names = FALSE,
                    namedRegion = NULL, na.strings = "NA", fillMergedCells = FALSE)%>%data.table()

filo=fildec%>%
  select(-LIBIRIS,-COM,-LIBCOM)%>%
  merge(fildisp,by="IRIS")

filo_75=filo[substr(COM,1,2)=="75",]
```


Fusion avec le reste

```{r}
filo_75=filo_75%>%
  select(-LIBIRIS,-COM,-LIBCOM)
```


```{r}
iris_csp_75=csp_75%>%
  merge(iris_75_df_data,
        by.y="C_IR",
        by.x="IRIS")%>%
  mutate(densite_C17_POP15P=C17_POP15P/M2_POP)



write.csv2(iris_csp_75,file="iris_csp_75.csv",sep=";")

```


```{r}
iris_csp_filo_75=iris_csp_75%>%
  merge(filo_75,by.x="C_IR",by.y="IRIS")

write.csv2(iris_csp_filo_75,file="iris_csp_filo_75.csv",sep=";")

```

pour toute la France

```{r}
iris_csp_filo=csp%>%
  merge(iris_data,
        by.y="C_IR",
        by.x="IRIS")%>%
  mutate(densite_C17_POP15P=C17_POP15P/M2_POP)%>%
  merge(filo,by="IRIS")

write.csv2(iris_csp_filo,file="iris_csp_filo.csv")

```


## Formation

```{r}
# https://www.insee.fr/fr/statistiques/5055909
# Revenus, pauvreté et niveau de vie en 2018 (Iris)

diplo=read.xlsx("../data/insee/base-ic-diplomes-formation-2017.xlsx",startRow = 6, colNames = TRUE,
                    skipEmptyCols = TRUE, rows = NULL, cols = NULL, check.names = FALSE,
                    namedRegion = NULL, na.strings = "NA", fillMergedCells = FALSE)%>%data.table()


diplo_75=diplo[substr(COM,1,2)=="75",c("IRIS","LIBIRIS","TYP_IRIS","P17_NSCOL15P_SUP5","P17_POP1517",
                                       "P17_POP1824",
                                       "P17_POP2529",
                                       "P17_POP30P")]%>%
  mutate(ratio=P17_NSCOL15P_SUP5/(P17_POP1517+P17_POP1824+P17_POP2529+P17_POP30P))


iris_75_diplo=sp::merge(iris_75,diplo_75,by.x="CODE_IRIS",by.y="IRIS")
names(diplo)

```

# CSP

## Données

```{r,eval=FALSE}

csp=read.xlsx("../data/insee/base-ic-evol-struct-pop-2017.xlsx",startRow = 6, colNames = TRUE,
                    skipEmptyCols = TRUE, rows = NULL, cols = NULL, check.names = FALSE,
                    namedRegion = NULL, na.strings = "NA", fillMergedCells = FALSE)%>%data.table()
for (i in 1:8){
  csp[[paste0("ratio_csp",i)]]=csp[[paste0("C17_POP15P_CS",i)]]/csp$C17_POP15P
}
```

## 75

```{r}
csp_75=csp[substr(COM,1,2)=="75",c("IRIS","LIBIRIS","P17_POP","C17_POP15P",paste0("C17_POP15P_CS",1:8))]

## CSP

csp_75=csp_75%>%
  mutate(ratio_csp3=C17_POP15P_CS3/C17_POP15P)

for (i in 1:8){
  csp_75[[paste0("ratio_csp",i)]]=csp_75[[paste0("C17_POP15P_CS",i)]]/csp_75$C17_POP15P
}

iris_csp_75=iris_75_data%>%
  mutate(C_IR=as.character(C_IR))%>%
  merge(csp_75,by.x="C_IR",by.y="IRIS")%>%
  mutate(densite_C17_POP15P=C17_POP15P/M2_POP)

```


```{r}
## population

pop_age_75=csp[substr(COM,1,2)=="75",
               c("IRIS","LIBIRIS","P17_POP","P17_POP0014","P17_POP1529",
                 "P17_POP3044","P17_POP4559","P17_POP6074","P17_POP75P")]

names(csp)

iris_75_csp=sp::merge(iris_75,csp_75,by.x="CODE_IRIS",by.y="IRIS")

```

## IDF

```{r}
csp_idf=csp[substr(COM,1,2) %in% c("75","77","78","91","92","93","94","95"),
           c("IRIS","LIBIRIS","P17_POP",
             paste0("C17_POP15P_CS",1:8))]

csp_idf=csp_idf%>%
  mutate(ratio_csp3=C17_POP15P_CS3/
           (C17_POP15P_CS1+C17_POP15P_CS2+C17_POP15P_CS3+C17_POP15P_CS4+
              C17_POP15P_CS5+C17_POP15P_CS6+
              C17_POP15P_CS7+C17_POP15P_CS8))

iris_idf_csp=sp::merge(iris_idf,csp_idf,by.x="CODE_IRIS",by.y="IRIS")

```
